<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="plone">

<metal:block fill-slot="top_slot"
    tal:define="dummy python:request.set('disable_border', 1);
                portal_url portal_state/portal_url">
</metal:block>

<body>

<metal:content-core fill-slot="main">
    <metal:block define-macro="main">
        <div id="content-core">
        <h1 class="documentFirstHeading" tal:content="view/label" i18n:translate=""></h1>
            <div id="cart-form"
                 tal:content="structure view/contents">
                 cart form
            </div>
            <script type="text/javascript">
        var form = $('#cart-form form');
        form.find('.bool-field.select > span').addClass('fa fa-times').find('input').hide();
        form.find('.header-select').hide();
        function removeCartLine(item) {
            $(item).animate({opacity: 0.0, height:'toggle'}, 1000, function() {$(this).remove()});
        };
        function updateCart(data) {
            var lines = data['lines'];
            var order = data['order'];
            for (var i = 0; i < lines.length; i++) {
                var ldata = lines[i];
                var lineid = ldata['id'];
                if (ldata['removed']) {
                    removeCartLine($('#crud-edit-'+lineid+'-widgets-set_qty').parents('div.table-row'));
                    removeCartLine($('[id^="crud-edit-'+lineid+'-option"][id$="-widgets-set_qty"].text-widget').parents('div.table-row'));
                    continue
                } else {
                    $('#crud-edit-'+lineid+'-widgets-set_qty.text-widget').html(ldata['product_uom_qty']);
                    $('[id^="crud-edit-'+lineid+'-option"][id$="-widgets-set_qty"].text-widget').html(ldata['product_uom_qty']);
                    var price_container = $('#crud-edit-'+lineid+'-widgets-view_price_formatted');
                    price_container.find('.lst_price').html(ldata['price_unit_formatted']);
                    price_container.find('.price').html(ldata['price_reduce_formatted']);
                    var total_container = $('#crud-edit-'+lineid+'-widgets-view_price_subtotal_formatted');
                    total_container.find('.price').html(ldata['price_subtotal_formatted']);
                }
            }
            $('#form-widgets-amount_total_formatted').html(order['amount_total_formatted']);
            $('#form-widgets-amount_untaxed_formatted').html(order['amount_untaxed_formatted']);
            $('#form-widgets-amount_tax_formatted').html(order['amount_tax_formatted']);
        };
        $('.product-viewlet').addClass('ajax_cart_load');
        $(form).find('.unavailable').css({'opacity':'0.5'});
        $(form).find('.unavailable input').attr('disabled','1');
        $(form).find('.color input:checked').parent().find('span.label').addClass('selected');
        var ajax_url = $(form).attr('action')+'-ajax';
        $(form).find('input.set_qty').change(function(event) {
            $('#kss-spinner').show();
            $('#ajax-spinner').show();
            var cur_input = $(this).find('input');
            var cur_name = $(this).attr('name');
            var cur_value = $(this).value;
            var prefix = cur_name.split('.')[0]+'.'+cur_name.split('.')[1]
            var submit_name = prefix+'.buttons.apply'
            var data = 'prefix='+prefix+'&'+submit_name+'=Submit&'+cur_name+'='+cur_value+'&ajax_load=1&ajax_cart_load=1';
            $.ajax({
                cache:false,
                url: ajax_url,
                type: "POST",
                data: data,
                dataType: 'json',
                async:false,
                success: function(msg){
                    updateCart(msg);
                    $('#kss-spinner').hide();
                    $('#ajax-spinner').hide();
                }
            });
        });
        $(form).find('[name$=".buttons.add"]').click(function(event) {
            event.preventDefault();
            $('#kss-spinner').show();
            $('#ajax-spinner').show();
            var cur_input = $(this).find('input')
            var cur_name = $(this).attr('name');
            var cur_value = $(this).attr('value');
            var prefix = cur_name.split('.')[0]+'.'+cur_name.split('.')[1]
            var submit_name = prefix+'.buttons.apply'
            var data = 'prefix='+prefix+'&'+submit_name+'=Submit&'+cur_name+'='+cur_value+'&ajax_load=1&ajax_cart_load=1';
            $.ajax({
                cache:false,
                url: ajax_url,
                type: "POST",
                data: data,
                dataType: 'json',
                async:false,
                success: function(msg){
                    updateCart(msg);
                    $('#kss-spinner').hide();
                    $('#ajax-spinner').hide();
                }
            });
        });
        form.find('.bool-field.select').click(function(event) {
            event.preventDefault();
            $('#kss-spinner').show();
            $('#ajax-spinner').show();
            var cur_input = $(this).parent().find('input')
            var cur_name = cur_input.attr('name');
            var cur_value = cur_input.attr('value');
            var prefix = cur_name.split('.')[0]+'.'+cur_name.split('.')[1]
            var submit_name = prefix+'.buttons.remove'
            var data = 'prefix='+prefix+'&'+submit_name+'=Submit&'+cur_name+'='+cur_value+'&ajax_load=1&ajax_cart_load=1';
            $.ajax({
                cache:false,
                url: ajax_url,
                type: "POST",
                data: data,
                dataType: 'json',
                async:false,
                success: function(msg){
                    updateCart(msg);
                    $('#kss-spinner').hide();
                    $('#ajax-spinner').hide();
                }
            });
        });
    </script>
        </div>
    </metal:block>
</metal:content-core>

</body>
</html>
